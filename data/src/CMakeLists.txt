cmake_minimum_required(VERSION 3.2)


set(test_src
  m1.cpp
  m2.cpp
  m3.cpp
  m4.cpp
  no_default.cpp
  simple_template_struct2.cpp
  simple_template_struct.cpp
)

add_library(test_lib STATIC
  ${test_src}
)


macro(ODR_COMPILE_OBJECT file)

get_filename_component(absInputPath ${file} ABSOLUTE)
get_filename_component(relInputName ${file} NAME)

add_custom_command(
  OUTPUT ${relInputName}.ast
  COMMAND ${CMAKE_CXX_COMPILER} -cc1 -emit-pch -o ${relInputName}.ast ${absInputPath}
  DEPENDS ${relInputName}
)

endmacro()


macro(ODR_CHECK_STATIC_LIBRARY libraryName)

file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/${libraryName}.autogenerated.cpp "//this file is autogenerated\n")

set(astfile_list)
set(astfile_list_args)
foreach (it ${ARGN})
  ODR_COMPILE_OBJECT(${it})
  set(astfile_list ${astfile_list} ${it}.ast)
  set(astfile_list_args ${astfile_list_args} -ast-merge ${it}.ast)
endforeach()

message("astfile_list: ${astfile_list}")
message("astfile_list_args: ${astfile_list_args}")


add_custom_target(
  ${libraryName}_ast ALL
  COMMAND ${CMAKE_CXX_COMPILER} -cc1 -emit-pch -o ${libraryName}.ast ${astfile_list_args} ${CMAKE_CURRENT_BINARY_DIR}/${libraryName}.autogenerated.cpp
  DEPENDS ${astfile_list} ${CMAKE_CURRENT_BINARY_DIR}/${libraryName}.autogenerated.cpp ${libraryName}
)

endmacro()


ODR_CHECK_STATIC_LIBRARY(test_lib
  ${test_src}
)

# $BD/bin/clang -cc1 -emit-pch -o output/m1.ast src/m1.cpp
# $BD/bin/clang -cc1 -emit-pch -o output/m2.ast src/m2.cpp
# $BD/bin/clang -cc1 -emit-pch -o output/m3.ast src/m3.cpp
# $BD/bin/clang -cc1 -emit-pch -o output/m4.ast src/m4.cpp

# $BD/bin/clang -cc1 -emit-pch -o output/m_res.ast -ast-merge output/m1.ast -ast-merge output/m2.ast -ast-merge output/m3.ast -ast-merge output/m4.ast src/empty.cpp


#add_custom_target(
#  test_lib_ast ALL
#  COMMAND ${CMAKE_CXX_COMPILER} -cc1 -emit-pch -o res.ast -ast-merge m1.ast -ast-merge m2.ast ${CMAKE_CURRENT_BINARY_DIR}/empty.cpp
#  DEPENDS m1.ast m2.ast
#)
